services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.4.2
    command: start-dev --import-realm
    ports:
      - "8080:8080"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: "true"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      # Uncomment after building/copying the provider JAR:
      # mvn -f keycloak-providers/legacy-user-storage/pom.xml package
      # cp keycloak-providers/legacy-user-storage/target/legacy-user-storage-provider-0.1.0-SNAPSHOT.jar compose/keycloak/providers/legacy-user-storage-provider.jar
      - ./keycloak/providers/legacy-user-storage-provider.jar:/opt/keycloak/providers/legacy-user-storage-provider.jar:ro
    healthcheck:
      test:
        - CMD-SHELL
        - "exec 3<>/dev/tcp/localhost/9000 && printf 'GET /health/ready HTTP/1.1\r\nHost: localhost\r\n\r\n' >&3 && head -n 1 <&3 | grep -q ' 200 ' && exec 3>&-"
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  starter:
    image: alpine:3.20.3
    depends_on:
      keycloak:
        condition: service_healthy
    entrypoint:
      - /bin/sh
      - -c
      - |
        cat <<'EOF'
        
        Keycloak is healthy and ready for migration tests.
        
        How to connect and authorize with running services:
        
        [Keycloak]
        - URL: http://localhost:8080/
        - Realm: research
        - Admin Console: http://localhost:8080/
          Admin credentials: admin / admin
        - Health: http://localhost:8080/health/ready
        
        [Users]
        - Test user: test-user / password
        
        [OIDC Client]
        - Client ID: research-migration-from-legacy (public)
        - Redirect URIs: http://localhost:4000/*
        - Web origins: *
        
        [Authorize in browser]
        - Start login: http://localhost:8080/realms/research/protocol/openid-connect/auth?client_id=research-migration-from-legacy&redirect_uri=http%3A%2F%2Flocalhost%3A4000%2F&response_type=code
        
        [Password grant (Direct Access Grants)]
        - Token endpoint: http://localhost:8080/realms/research/protocol/openid-connect/token
        - Example:
          curl -X POST \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d 'grant_type=password' \
            -d 'client_id=research-migration-from-legacy' \
            -d 'username=test-user' \
            -d 'password=password' \
            'http://localhost:8080/realms/research/protocol/openid-connect/token'
        
        [Helper script]
        - From project root:
          ./scripts/keycloak-login.sh test-user password
        
        [Legacy service expected by provider]
        - External base URL: http://localhost:4000/
        - From inside Keycloak container: http://host.docker.internal:4000/
        
        EOF
